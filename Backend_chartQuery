// server.js
const express = require('express');
const sql = require('mssql');
const path = require('path');

const app = express();

// SQL Server config
const config = {
  user: 'serviceSQL',
  password: 'Linkup1J',
  server: 'DB1',
  database: 'echo23',
  options: {
    encrypt: false,
    trustServerCertificate: true
  }
};

// Create a single connection pool
const poolPromise = new sql.ConnectionPool(config)
  .connect()
  .then(pool => {
    console.log('âœ… Connected to SQL Server');
    return pool;
  })
  .catch(err => console.error('âŒ Database connection failed:', err));

// API endpoint to get chart data
app.get('/api/chart-data', async (req, res) => {
  try {
    const pool = await poolPromise;
    const result = await pool.request().query(`
      SELECT 
        COUNT(*) AS totalDevices,
        SUM(CASE WHEN status = 'Active' THEN 1 ELSE 0 END) AS activeDevices,
        SUM(CASE WHEN status = 'Inactive' THEN 1 ELSE 0 END) AS inactiveDevices,
        SUM(CASE WHEN department = 'IT' THEN 1 ELSE 0 END) AS itDept,
        SUM(CASE WHEN department = 'HR' THEN 1 ELSE 0 END) AS hrDept
      FROM Devices
    `);

    res.json(result.recordset[0]);
  } catch (err) {
    console.error(err);
    res.status(500).send('Database error');
  }
});

// Serve static frontend (your HTML with charts)
app.use(express.static(path.join(__dirname, 'public')));

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`ðŸš€ Server running on http://localhost:${PORT}`));
